<template>
	<div class="details-wrapper">
		<div class="effects">
			<div v-for="effect in entity.effects" :key="effect.id" :value="effectText(effect)" class="effect">
				<img :src="effect.texture.src">
			</div>
		</div>
		<div :class="{dead: entity.dead, dark}" class="details">
			<div class="image">
				<img v-if="entity.summon" :src="'/image/bulb/' + entity.bulbName + '_front.png'">
				<turret-image v-else-if="(entity instanceof Turret)" :level="entity.level" :skin="entity.team" :scale="0.15" />
				<leek-image v-else :leek="entity" :scale="0.3" />
			</div>
			<div>
				<div class="flex">
					<span class="name">{{ entity.name }}</span>&nbsp;
					<div class="spacer"></div>
					<span class="level">{{ $t('main.level_n', [entity.level]) }}</span>
					<div class="bar-wrapper">
						<div :style="{width: (100 * entity.life / entity.maxLife) + '%', background: entity.lifeColor}" class="details-bar"></div>
					</div>
					<div>{{ entity.farmer_name }}</div>
					<avatar :farmer="entity.farmer" class="farmer-avatar" />
				</div>
				<div class="stats">
					<div :class="{zero: entity.life === 0}" class="stat life">
						<img src="/image/charac/small/life.png">
						<div :class="{small: entity.maxLife > 9999}" class="color-life">{{ entity.life + ' / ' + entity.maxLife }}</div>
					</div>
					<div :class="{zero: entity.tp === 0}" class="stat">
						<img src="/image/charac/small/tp.png">
						<div class="tp color-tp">{{ entity.tp }}</div>
					</div>
					<div :class="{zero: entity.mp === 0}" class="stat">
						<img src="/image/charac/small/mp.png">
						<div class="mp color-mp">{{ entity.mp }}</div>
					</div>
					<div :class="{zero: entity.absoluteShield === 0, dark}" class="stat black">
						<img src="/image/charac/small/absolute_shield.png">
						<div class="absolute-shield">{{ entity.absoluteShield }}</div>
					</div>
					<div :class="{zero: entity.relativeShield === 0, dark}" class="stat black">
						<img src="/image/charac/small/relative_shield.png">
						<div class="relative-shield">{{ entity.relativeShield }}%</div>
					</div>
					<div :class="{zero: entity.damageReturn === 0, dark}" class="stat black">
						<img src="/image/charac/small/damage_return.png">
						<div class="damage-return">{{ entity.damageReturn }}%</div>
					</div>
				</div>
				<div class="stats">
					<div :class="{zero: entity.strength === 0}" class="stat">
						<img src="/image/charac/small/strength.png" :class="{dark}">
						<div class="strength color-strength" :class="{dark}">{{ entity.strength }}</div>
					</div>
					<div :class="{zero: entity.wisdom === 0}" class="stat">
						<img src="/image/charac/small/wisdom.png">
						<div class="wisdom color-wisdom">{{ entity.wisdom }}</div>
					</div>
					<div :class="{zero: entity.agility === 0}" class="stat">
						<img src="/image/charac/small/agility.png">
						<div class="agility color-agility">{{ entity.agility }}</div>
					</div>
					<div :class="{zero: entity.resistance === 0}" class="stat">
						<img src="/image/charac/small/resistance.png">
						<div class="resistance color-resistance">{{ entity.resistance }}</div>
					</div>
					<div :class="{zero: entity.science === 0, dark}" class="stat">
						<img src="/image/charac/small/science.png">
						<div class="science color-science">{{ entity.science }}</div>
					</div>
					<div :class="{zero: entity.magic === 0, dark}" class="stat">
						<img src="/image/charac/small/magic.png">
						<div class="magic color-magic">{{ entity.magic }}</div>
					</div>
					<div :class="{zero: entity.frequency === 0, dark}" class="stat black">
						<img src="/image/charac/small/frequency.png">
						<div class="frequency color-frequency">{{ entity.frequency }}</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>

<script lang="ts">
	import { Effect, EffectType } from '@/model/effect'
	import { Component, Prop, Vue, Watch } from 'vue-property-decorator'
	import { FightEntity } from './game/entity'
	import { Game } from './game/game'
	import { Turret } from './game/turret'

	@Component({ name: 'entity-details' })
	export default class EntityDetails extends Vue {
		@Prop({required: true}) entity!: FightEntity
		@Prop({required: true}) dark!: boolean
		Turret = Turret

		effectText(effect: any) {
			let r = '' + effect.value
			if (effect.effect === EffectType.SHACKLE_MAGIC || effect.effect === EffectType.SHACKLE_MP || effect.effect === EffectType.SHACKLE_TP || effect.effect === EffectType.SHACKLE_STRENGTH || effect.effect === EffectType.VULNERABILITY || effect.effect === EffectType.ABSOLUTE_VULNERABILITY) {
				r = '-' + r
			}
			if (effect.effect === EffectType.RELATIVE_SHIELD || effect.effect === EffectType.DAMAGE_RETURN || effect.effect === EffectType.VULNERABILITY) {
				r += '%'
			}
			return r
		}
	}
</script>

<style lang="scss" scoped>
.details-wrapper {
	position: absolute;
	bottom: 6px;
	right: 0;
	width: 395px;
}
.details {
	width: 100%;
	padding: 4px 5px;
	background-color: #fff;
	box-shadow: 0px 2px 4px -1px rgba(0,0,0,0.2), 0px 4px 5px 0px rgba(0,0,0,0.14), 0px 1px 10px 0px rgba(0,0,0,0.12);
	border-top-left-radius: 5px;
	display: flex;
	align-items: center;
	&.dark {
		background-color: #222;
		color: #eee;
	}
	& > * {
		flex: 1;
	}
}
.details.dead {
	background: rgba(255,255,255,0.3);
}
.image {
	flex: 45px 0 0;
	margin-right: 5px;
	display: flex;
	align-items: flex-end;
	max-height: 78px;
	width: 45px;
	img {
		max-width: 45px;
		max-height: 78px;
	}
}
.flex {
	align-items: center;
	margin-right: -4px;
}
.name {
	font-weight: 500;
	width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.level {
	white-space: nowrap;
}
.spacer {
	flex: 1;
}
.details .bar-wrapper {
	flex-basis: 200px;
	height: 8px;
	border: 1px solid #999;
	margin: 0 6px;
	border-radius: 3px;
}
.details .details-bar {
	height: 6px;
}
.farmer-avatar {
	width: 30px;
	height: 30px;
}
.stats {
	display: flex;
	width: 100%;
	margin-top: 4px;
	gap: 2px;
}
.stat {
	flex: 1;
	display: inline-block;
	font-size: 14px;
	font-weight: bold;
	white-space: nowrap;
	div {
		display: inline-block;
		vertical-align: bottom;
		margin-bottom: 2px;
	}
	img {
		width: 14px;
		margin-right: 3px;
	}
	&.dark {
		filter: brightness(180%);
	}
	&.black {
		color: black;
		&.dark {
			filter: invert(100%);
		}
	}
	&.zero {
		opacity: 0.25;
		&.dark {
			opacity: 0.9;
		}
		&.black.dark {
			opacity: 0.3;
		}
	}
}
.stat.life {
	flex: 2;
}
.small {
	font-size: 14px;
	padding-bottom: 2px;
}
.effects {
	padding: 4px;
	right: 0;
	white-space: nowrap;
	display: inline-block;
	position: absolute;
	top: -44px;
}
.effects .effect {
	position: relative;
	display: inline-block;
	img {
		width: 36px;
		height: 36px;
		margin-left: 4px;
		vertical-align: bottom;
		object-fit: fill;
	}
}
.effects .effect:after {
	position: absolute;
	bottom: 0;
	left: 4px;
	padding: 1px 2px;
	content: attr(value);
	color: white;
	font-weight: bold;
	background: rgba(0,0,0,0.5);
	border-top-right-radius: 7px;
	border-bottom-left-radius: 10px;
	font-size: 12px;
}
</style>